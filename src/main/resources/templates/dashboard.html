<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>API ä»ªè¡¨ç›˜</title>
    <link rel="icon" href="images/sky-logo.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- å¤–éƒ¨CSSæ–‡ä»¶ - æå‡ç¼“å­˜æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ -->
    <link rel="stylesheet" th:href="@{/css/dashboard-core.css?v=1}">

    <!-- æ˜Ÿç©ºèƒŒæ™¯Canvaså…ƒç´  - è£…é¥°æ€§åŠ¨ç”»æ•ˆæœ -->
    <canvas id="star-canvas" aria-label="è£…é¥°æ€§æ˜Ÿç©ºèƒŒæ™¯åŠ¨ç”»"
        style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999; pointer-events:none;"></canvas>

    <!-- ä¸»è¦JavaScriptæ–‡ä»¶ - Dashboardæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ -->
    <script th:src="@{/js/dashboard-v3.js?v=1}" defer></script>

    <!-- é”®ç›˜å¯¼èˆªå¢å¼ºè„šæœ¬ - æå‡æ— éšœç¢è®¿é—®ä½“éªŒ -->
    <script th:src="@{/js/keyboard-navigation.js}" defer></script>
</head>

<body>

    <div class="container">
        <header>
            <div class="planet-glow"></div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 5px;">
                <img src="images/sky-logo.png"
                    style="height: 56px; border-radius: 50%; box-shadow: 0 0 20px rgba(0, 113, 227, 0.5); border: 2px solid rgba(255, 255, 255, 0.1);">
                <h1 style="margin:0;">API ä»ªè¡¨ç›˜</h1>
            </div>
            <p class="subtitle">æç®€ Â· é«˜æ•ˆ Â· æ™ºèƒ½</p>
            <div class="glass-bar">
                <label for="target-host"
                    style="font-weight: 600; color: var(--text-secondary); font-size: 13px;">ç›®æ ‡:</label>
                <input type="text" id="target-host" class="glass-input" th:value="${baseUrl}" placeholder="Host URL">

                <span style="opacity:0.3; color:#aaa; margin:0 4px;">|</span>

                <span style="font-size:14px; opacity:0.8;">ğŸ”</span>
                <input type="text" id="api-search" class="glass-input" placeholder="Search API..."
                    style="width: 120px;">

                <a href="javascript:void(0)" onclick="window.openGlobalConsole()" class="glass-btn">
                    <span>ğŸ› ï¸</span> è°ƒè¯•
                </a>

                <button onclick="openSettings()" class="glass-btn" aria-label="æ‰“å¼€å…¨å±€è®¾ç½®" tabindex="0"
                    style="background: rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.2);">
                    <span aria-hidden="true">âš™ï¸</span> è®¾ç½®
                </button>
            </div>
        </header>

        <!-- ========================================
             ä¸»å¸ƒå±€ - ä¾§è¾¹æ  + API åˆ—è¡¨
             ======================================== -->

        <!-- ä¾§è¾¹æ æŠ˜å æŒ‰é’® - å›ºå®šåœ¨å·¦ä¾§ -->
        <button id="sidebar-toggle" onclick="toggleSidebarNew()" aria-label="å±•å¼€/æŠ˜å ä¾§è¾¹æ å¯¼èˆª" aria-expanded="false"
            tabindex="0"
            style="position:fixed; top:260px; left:20px; z-index:201; background:rgba(255,255,255,0.1); border:none; color:#fff; width:32px; height:32px; border-radius:8px; cursor:pointer; backdrop-filter:blur(10px); display:block; transition: left 0.3s ease;">
            <span aria-hidden="true">â˜°</span>
        </button>

        <!-- åˆ†ç±»ä¾§è¾¹æ  - æ˜¾ç¤ºAPIåˆ†ç»„å¯¼èˆª -->
        <aside id="sidebar"
            style="width: 240px; position: fixed; top: 260px; left: 20px; height: calc(100vh - 280px); overflow-y: auto; border-radius: 16px; padding: 60px 16px 16px 16px; display:none; z-index: 200; transition: all 0.3s ease;">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px; padding-left: 10px;">
                <h4
                    style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.1em; margin:0;">
                    å¯¼èˆª</h4>
                <span style="font-size:12px; color:#666; cursor:pointer;" onclick="toggleSidebarNew()">âœ•</span>
            </div>
            <div id="sidebar-list" style="display: flex; flex-direction: column; gap: 4px;"></div>
        </aside>

        <div id="main-content">
            <!-- API åˆ—è¡¨å®¹å™¨ - åŠ¨æ€åŠ è½½æ§åˆ¶å™¨å’Œæ¥å£ -->
            <div id="api-list-container" style="flex:1;">
                <div style="text-align:center; padding: 40px; color:white;">
                    Loading API Definitions...
                </div>
            </div>
        </div>

    </div>

    <!-- ========================================
         å…¨å±€è®¾ç½®æ¨¡æ€æ¡†
         ======================================== -->
    <div id="settingsOverlay" class="overlay" onclick="if(event.target===this) closeSettings()" role="dialog"
        aria-modal="true" aria-labelledby="settings-title">
        <div class="modal" role="document">
            <h3 id="settings-title">å…¨å±€é…ç½® (Global Settings)</h3>
            <p style="font-size:13px; color:var(--text-secondary); margin-bottom: 20px;">è®¾ç½®å°†æŒä¹…åŒ–å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­ï¼Œè‡ªåŠ¨åº”ç”¨äºæ‰€æœ‰è°ƒè¯•è¯·æ±‚ã€‚</p>

            <div style="margin-bottom: 24px;">
                <label class="form-label">å…¨å±€ Headers (ä¸€è¡Œä¸€ä¸ª Key: Value)</label>
                <textarea id="globalHeaders" style="height: 150px;"
                    placeholder="Authorization: Bearer my-token&#10;X-Custom-Header: value"></textarea>
            </div>

            <div style="display:flex; justify-content: flex-end; gap:10px;">
                <button class="btn-cancel" onclick="closeSettings()" aria-label="å–æ¶ˆè®¾ç½®æ›´æ”¹">å–æ¶ˆ</button>
                <button class="btn-primary" onclick="window.saveSettings()" aria-label="ä¿å­˜å…¨å±€é…ç½®">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- ========================================
         API æµ‹è¯•æ¨¡æ€æ¡† - ç®€å•æµ‹è¯•
         ======================================== -->
    <div id="overlay" class="overlay" onclick="closeModal()"></div>
    <div id="modal" class="modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
            <div style="display:flex; align-items:center; gap:10px;">
                <img src="images/sky-logo.png" style="height: 28px; border-radius: 50%;">
                <h3 style="margin:0; font-size: 20px;">æ¥å£æµ‹è¯•</h3>
            </div>
            <div id="loader" class="spinner"></div>
        </div>

        <div class="form-group">
            <span class="form-label">è¯·æ±‚åœ°å€</span>
            <input type="text" id="inpUrl" class="form-input" readonly>
        </div>

        <div class="form-group">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span class="form-label">è¯·æ±‚æ–¹æ³•</span>
                <div class="segmented-control" id="bodyTypeControl" style="display:none; font-size:12px;">
                    <div class="segment body-toggle active" data-mode="json" onclick="setBodyMode('json')">JSON</div>
                    <div class="segment body-toggle" data-mode="form" onclick="setBodyMode('form')">Form</div>
                </div>
            </div>
            <div class="segmented-control" id="methodControl">
                <div class="segment" onclick="setMethod('GET')">GET</div>
                <div class="segment" onclick="setMethod('POST')">POST</div>
                <div class="segment" onclick="setMethod('PUT')">PUT</div>
                <div class="segment" onclick="setMethod('DELETE')">DEL</div>
            </div>
            <input type="hidden" id="inpMethod">
        </div>

        <!-- Headers é…ç½®åŒº -->
        <div class="form-group">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <span class="form-label">Headers (Request)</span>
                <button class="btn-add" onclick="addHeaderKv()">+ æ·»åŠ  Header</button>
            </div>
            <div id="headerKvContainer"></div>
        </div>

        <!-- å‚æ•°åŒºåŸŸ - æ ¹æ®æ–¹æ³•è‡ªåŠ¨åˆ‡æ¢ -->
        <div id="kvParamsArea" style="display:none;">
            <div class="form-group">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span class="form-label" id="paramLabel">URL å‚æ•°</span>
                    <button class="btn-add" onclick="addKv()">+ æ·»åŠ å‚æ•°</button>
                </div>
                <div id="kvContainer"></div>
            </div>
        </div>

        <div id="jsonParamsArea" style="display:none;">
            <div class="form-group">
                <span class="form-label">è¯·æ±‚ä½“ (JSON)</span>
                <button class="btn-add" onclick="formatJson()">æ ¼å¼åŒ–</button>
            </div>
            <textarea id="inpJson" rows="8"></textarea>
        </div>

        <div style="display:flex; justify-content: flex-end; gap:10px; margin-top:20px; margin-bottom: 10px;">
            <button class="btn-utility" onclick="copyCurl()">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                    <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                </svg>
                Copy cURL
            </button>
            <button class="btn-cancel" onclick="closeModal()" aria-label="å…³é—­æµ‹è¯•çª—å£">å…³é—­</button>
            <button class="btn-primary" onclick="window.sendRequest()" aria-label="å‘é€APIæµ‹è¯•è¯·æ±‚">å‘é€è¯·æ±‚ (Send)</button>
        </div>

        <!-- çŠ¶æ€æ  - æ˜¾ç¤ºè¯·æ±‚çŠ¶æ€ã€è€—æ—¶ã€å¤§å° -->
        <div id="t-status-bar"
            style="border: 1px solid var(--divider); border-bottom: none; background: rgba(255,255,255,0.02); padding: 8px 12px; display:none; align-items: center; gap: 16px; font-size: 13px; color: var(--text-secondary); border-radius: 6px 6px 0 0;">
            <span id="t-status" class="c-badge"
                style="padding: 2px 8px; border-radius: 4px; background: #333; color: #fff; font-weight: bold; font-size: 12px;">Ready</span>
            <span style="margin-left:auto;">â± <span id="t-time">0 ms</span></span>
            <span>ğŸ“¦ <span id="t-size">0 B</span></span>
        </div>

        <div style="position:relative;">
            <button class="btn-copy" onclick="copyResponse()" style="top:5px; right:5px; color:#666;"
                title="Copy Response">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
            </button>
            <div id="responseBox" class="response-box"
                style="border-top-left-radius: 0; border-top-right-radius: 0; margin-top:0;"></div>
        </div>
    </div>

    <!-- ========================================
         é«˜çº§è°ƒè¯•æ§åˆ¶å° - å®Œæ•´åŠŸèƒ½æµ‹è¯•
         ======================================== -->
    <div id="consoleModal" class="overlay" style="display: none;">
        <div class="modal modal-large">
            <div class="modal-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="images/sky-logo.png" style="height: 28px; border-radius: 50%;">
                    <h3>ğŸ› ï¸ é«˜çº§è°ƒè¯•å° (Console)</h3>
                </div>
                <!-- 1ï¸âƒ£ å†å²è®°å½•æŒ‰é’® -->
                <div style="display:flex; gap:10px; align-items:center;">
                    <button id="history-btn" onclick="toggleHistoryDropdown(event)" class="btn-secondary"
                        style="font-size:12px; padding:4px 10px;">
                        ğŸ“œ å†å²è®°å½•
                    </button>
                    <button class="btn-icon" onclick="closeConsoleModal()">&times;</button>
                </div>
            </div>

            <!-- å†å²è®°å½•ä¸‹æ‹‰åˆ—è¡¨ - æ˜¾ç¤ºæœ€è¿‘5æ¬¡è¯·æ±‚ -->
            <div id="history-dropdown"
                style="display:none; position:absolute; top:50px; right:20px; width:300px; background:var(--glass-bg); backdrop-filter:blur(20px); border:1px solid var(--glass-border); border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.5); z-index:1000; overflow:hidden;">
                <div
                    style="padding:10px 15px; border-bottom:1px solid rgba(255,255,255,0.1); font-size:12px; font-weight:600; color:#aaa; display:flex; justify-content:space-between;">
                    <span>æœ€è¿‘ 5 æ¬¡è®°å½•</span>
                    <span style="cursor:pointer;" onclick="toggleHistoryDropdown(event)">âœ•</span>
                </div>
                <div id="history-list" style="max-height:300px; overflow-y:auto;">
                    <!-- JS å¡«å…… -->
                </div>
            </div>

            <div class="console-layout">
                <!-- Left: Request -->
                <div class="c-col-left">
                    <!-- URL Bar -->
                    <div style="display: flex; gap: 10px;">
                        <select id="c-method" class="form-input"
                            style="width: 100px; text-align:center; font-weight:bold;" onchange="updateConsoleUI()">
                            <option value="GET">GET</option>
                            <option value="POST" selected>POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                        <input type="text" id="c-url" class="form-input" placeholder="/api/...">
                    </div>

                    <div style="display: flex; gap: 10px; align-items: center;">
                        <label style="font-size: 12px; color:#666; white-space: nowrap;">Base URL:</label>
                        <input type="text" id="c-base" class="form-input"
                            style="font-family: monospace; font-size: 12px; color: #666;">
                    </div>

                    <!-- Tab åˆ‡æ¢ - Body / Headers -->
                    <div class="console-tabs">
                        <div class="c-tab active" onclick="switchConsoleTab(this, 'c-tab-body')">Body</div>
                        <div class="c-tab" onclick="switchConsoleTab(this, 'c-tab-headers')">Headers</div>
                    </div>

                    <!-- Tab Content -->
                    <div id="c-tab-body" class="c-tab-content">
                        <!-- Body Type Toggle (Postman Style) -->
                        <div id="c-body-controls"
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px;">
                            <span style="font-size:12px; color:#aaa;">Request Body</span>
                            <div class="segmented-control" style="font-size:11px;">
                                <div class="segment active" id="c-bt-json" onclick="setConsoleBodyType('json')">JSON
                                </div>
                                <div class="segment" id="c-bt-form" onclick="setConsoleBodyType('form')">Form</div>
                            </div>
                        </div>
                        <div id="c-body-container">
                            <textarea id="c-body" class="console-editor"
                                placeholder="{ &quot;key&quot;: &quot;value&quot; }"></textarea>
                        </div>
                        <div id="c-body-msg"
                            style="display:none; text-align:center; padding: 20px; color: #666; font-size: 13px;">
                            GET è¯·æ±‚ä¸åŒ…å« Body (GET requests usually have no body)
                        </div>


                    </div>
                    <div id="c-tab-headers" class="c-tab-content" style="display:none;">
                        <div style="margin-bottom: 5px; display: flex; gap: 10px; align-items: center;">
                            <label style="font-size: 12px; color: #aaa;">é¢„è®¾ Header:</label>
                            <select class="form-input" style="font-size: 12px; height: 26px; padding: 0 8px;"
                                onchange="addHeaderPreset(this)">
                                <option value="">-- é€‰æ‹©å¹¶æ·»åŠ  --</option>
                                <option value="Content-Type: application/json">Content-Type: JSON</option>
                                <option value="Content-Type: application/x-www-form-urlencoded">Content-Type: Form
                                </option>
                                <option value="Authorization: Bearer ">Authorization: Bearer ...</option>
                                <option value="User-Agent: SmartRelay/1.0">User-Agent: SmartRelay</option>
                                <option value="Accept: application/json">Accept: JSON</option>
                            </select>
                        </div>
                        <textarea id="c-headers" style="height: 300px;" placeholder="Header: Value (ä¸€è¡Œä¸€ä¸ª)"></textarea>

                        <script>
                            function addHeaderPreset(select) {
                                const val = select.value;
                                if (!val) return;
                                const area = document.getElementById('c-headers');
                                if (area.value.trim()) area.value += '\n';
                                area.value += val;
                                select.value = ""; // reset
                            }
                        </script>
                    </div>

                    <div style="margin-top: auto; display: flex; justify-content: flex-end; gap: 10px;">
                        <button class="btn-utility" onclick="copyCurl()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2">
                                </path>
                                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                            </svg>
                            Copy cURL
                        </button>
                        <button class="btn-cancel" onclick="closeConsoleModal()">å…³é—­</button>
                        <button class="btn-primary" onclick="execConsoleRequest()">å‘é€è¯·æ±‚ (Send)</button>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šå“åº”ç»“æœæ˜¾ç¤ºåŒº -->
                <div class="c-col-right" style="position:relative;">
                    <div style="font-size: 13px; font-weight: 600; color: #666; margin-bottom: 10px;">å“åº”ç»“æœ</div>
                    <button class="btn-copy" onclick="copyResponse()" title="Copy Response">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                        </svg>
                    </button>

                    <div id="c-status-bar" class="c-status-bar" style="display:none;">
                        <span id="c-status" class="c-badge">-</span>
                        <span id="c-time">0 ms</span>
                        <span id="c-size">0 B</span>
                    </div>

                    <pre id="c-res-body"
                        style="font-family: 'SF Mono', monospace; font-size: 11px; color: #333; white-space: pre-wrap; overflow-wrap: break-word;"></pre>
                </div>
            </div>
        </div>
    </div>

</body>

</html>